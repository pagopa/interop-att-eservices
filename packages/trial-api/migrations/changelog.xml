<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">
    
    <changeSet id="1" author="technical_user" runOnChange="true">
        <!-- Controllo condizionale per verificare se esiste giÃ  una transazione con id 1 -->
        <preConditions onFail="WARN">
            <sqlCheck expectedResult="0">SELECT COUNT(*) FROM  databasechangelog WHERE id::int = 1</sqlCheck>
        </preConditions>
        
        <!-- Se la transazione con id 1 non esiste, esegui le modifiche -->
        <sql>
            CREATE TABLE category (
                id bigserial NOT NULL,
                code varchar NOT NULL,
                eservice varchar NOT NULL,
                description varchar NULL,
                "order" int8 NOT NULL,
                CONSTRAINT category_pk PRIMARY KEY (id)
            );
            CREATE INDEX category_eservice_idx ON category USING btree (eservice);
            
            CREATE TABLE "check" (
                id bigserial NOT NULL,
                code varchar NOT NULL,
                description varchar NULL,
                "order" int8 NOT NULL,
                category_id int8 NULL,
                CONSTRAINT check_pk PRIMARY KEY (id),
                CONSTRAINT check_category_fk FOREIGN KEY (category_id) REFERENCES category(id)
            );
            
            CREATE TABLE trial (
                id bigserial NOT NULL,
                execution_date timestamp NULL,
                check_id int8 NOT NULL,
                purpose_id varchar NOT NULL,
                response bool DEFAULT false NULL,
                message varchar NULL,
                "order" int8 NOT NULL,
                CONSTRAINT trial_pk PRIMARY KEY (id),
                CONSTRAINT trial_check_fk FOREIGN KEY (check_id) REFERENCES "check"(id)
            );

            CREATE INDEX trial_purpose_id_idx ON trial USING btree (purpose_id);
        </sql>
    </changeSet>

</databaseChangeLog>
